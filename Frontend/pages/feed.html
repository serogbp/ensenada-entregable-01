<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Feed</title>
		<link rel="stylesheet" href="../public/css/bootstrap.css" />
		<link rel="stylesheet" href="../public/css/global.css" />
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css" />
		<link rel="stylesheet" href="../public/css/feed.css" />
		<script src="../public/js/bootstrap.bundle.js"></script>
	</head>
	<body class="min-vh-100 bg-light">
		<!-- Header -->
		<header class="sticky-top shadow-sm">
			<nav class="navbar navbar-expand-lg bg-white">
				<div class="container-fluid">
					<a class="navbar-brand font-family--jetbrains-mono" href="#"
						><!-- LOGO -->
						<strong>//TECLA</strong>_SOCIAL
					</a>
					<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
						<span class="navbar-toggler-icon"></span>
					</button>
					<div class="collapse navbar-collapse justify-content-end" id="navbarSupportedContent">
						<div class="text-start d-lg-none mt-4 overflow-scroll">
							<!-- Lista -->
							<ul class="nav-list list-unstyled card">
								<p class="h5 mb-1 font-family--jetbrains-mono">Enlaces</p>
								<a href="/pages/feed.html"><li>🧾 Feed</li></a>
								<a href="/pages/perfil-de-usuario.html"><li>🏠 Mi perfil</li></a>
								<a href="/pages/lista-de-amigos.html"><li>💃 Amigos</li></a>
								<li>📜 Anuncios</li>
								<li>🎙 Podcast</li>
								<li>🔑 Tags</li>
								<li>📊 Noticias</li>
								<li>💡 FAQ</li>
								<li>💬 Publicaciones</li>
								<li>📖 Guías</li>
							</ul>
						</div>
						<form class="d-flex" role="search">
							<input class="form-control me-2" type="search" placeholder="Buscar" aria-label="Buscar" />
							<button class="btn btn-outline-success" type="submit">Buscar</button>
						</form>
					</div>
				</div>
			</nav>
		</header>

		<!-- Main content -->
		<div class="d-flex gap-3 p-3 justify-content-center">
			<!-- 🔴 Left Nav Bar -->
			<nav class="left-column d-none d-md-flex justify-content-end">
				<div class="text-start">
					<!-- Lista -->
					<ul class="nav-list list-unstyled card">
						<p class="h5 mb-1 font-family--jetbrains-mono">Enlaces</p>
						<a href="/pages/feed.html"><li>🧾 Feed</li></a>
						<a href="/pages/perfil-de-usuario.html"><li>🏠 Mi perfil</li></a>
						<a href="/pages/lista-de-amigos.html"><li>💃 Amigos</li></a>
						<li>📜 Anuncios</li>
						<li>🎙 Podcast</li>
						<li>🔑 Tags</li>
						<li>📊 Noticias</li>
						<li>💡 FAQ</li>
						<li>💬 Publicaciones</li>
						<li>📖 Guías</li>
					</ul>
					<!-- Lista -->
					<ul class="nav-list list-unstyled card">
						<p class="h5 mb-1 font-family--jetbrains-mono">Otros</p>
						<li>👍 Código de conducta</li>
						<li>🤓 Política de privacidad</li>
						<li>👀 Términos de uso</li>
					</ul>
				</div>
			</nav>

			<!-- 🔴 Feed -->
			<main class="middle-column d-flex flex-column gap-3 overflow-auto">
				<!-- 🎠 Carousel Stories -->
				<div class="d-flex overflow-auto nowrap gap-2">
					<div class="story">
						<div class="avatar">
							<i class="icon text-tecla-blue bi bi-plus"></i>
						</div>
						<p>Añadir Historia</p>
					</div>
					<div class="story story--image-background">
						<div class="avatar avatar--image"></div>
						<p>Nombre Apellido</p>
					</div>
					<div class="story story--image-background">
						<div class="avatar avatar--image"></div>
						<p>Nombre Apellido</p>
					</div>
					<div class="story story--image-background">
						<div class="avatar avatar--image"></div>
						<p>Nombre Apellido</p>
					</div>
					<div class="story story--image-background">
						<div class="avatar avatar--image"></div>
						<p>Nombre Apellido</p>
					</div>
					<div class="story story--image-background">
						<div class="avatar avatar--image"></div>
						<p>Nombre Apellido</p>
					</div>
					<div class="story story--image-background">
						<div class="avatar avatar--image"></div>
						<p>Nombre Apellido</p>
					</div>
					<div class="story story--image-background">
						<div class="avatar avatar--image"></div>
						<p>Nombre Apellido</p>
					</div>
					<div class="story story--image-background">
						<div class="avatar avatar--image"></div>
						<p>Nombre Apellido</p>
					</div>
					<div class="story story--image-background">
						<div class="avatar avatar--image"></div>
						<p>Nombre Apellido</p>
					</div>
					<div class="story story--image-background">
						<div class="avatar avatar--image"></div>
						<p>Nombre Apellido</p>
					</div>
					<div class="story story--image-background">
						<div class="avatar avatar--image"></div>
						<p>Nombre Apellido</p>
					</div>
					<div class="story story--image-background">
						<div class="avatar avatar--image"></div>
						<p>Nombre Apellido</p>
					</div>
				</div>

				<!-- 📝 Posts -->
				<div id="post-creator" class="flex-col posts"></div>
				<div id="post-wrapper" class="flex-col posts"></div>
			</main>

			<!-- 🔴 Aside -->
			<aside class="right-column d-none d-xl-flex flex-column gap-3">
				<!-- Peticiones de amistad -->
				<div class="card gap-4">
					<p class="h5 mb-1 font-family--jetbrains-mono">Peticiones de amistad</p>
					<!-- Item -->
					<div class="d-flex flex-column gap-2">
						<div class="d-flex gap-4">
							<div class="avatar avatar--image"></div>
							<div class="doble-texto">
								<p>Nombre Apellido</p>
								<p>12 amigos en común</p>
							</div>
						</div>
						<div class="d-flex gap-4">
							<button class="btn btn-outline-primary rounded-circle">
								<i class="icon bi bi-check-lg"></i>
							</button>
							<button class="btn btn-outline-danger rounded-circle">
								<i class="icon bi bi-x-lg"></i>
							</button>
						</div>
					</div>
					<!-- Item -->
					<div class="d-flex flex-column gap-2">
						<div class="d-flex gap-4">
							<div class="avatar avatar--image"></div>
							<div class="doble-texto">
								<p>Nombre Apellido</p>
								<p>12 amigos en común</p>
							</div>
						</div>
						<div class="d-flex gap-4">
							<button class="btn btn-outline-primary rounded-circle">
								<i class="icon bi bi-check-lg"></i>
							</button>
							<button class="btn btn-outline-danger rounded-circle">
								<i class="icon bi bi-x-lg"></i>
							</button>
						</div>
					</div>
					<!-- Item -->
					<div class="d-flex flex-column gap-2">
						<div class="d-flex gap-4">
							<div class="avatar avatar--image"></div>
							<div class="doble-texto">
								<p>Nombre Apellido</p>
								<p>12 amigos en común</p>
							</div>
						</div>
						<div class="d-flex gap-4">
							<button class="btn btn-outline-primary rounded-circle">
								<i class="icon bi bi-check-lg"></i>
							</button>
							<button class="btn btn-outline-danger rounded-circle">
								<i class="icon bi bi-x-lg"></i>
							</button>
						</div>
					</div>
				</div>
				<!-- Eventos -->
				<div class="card gap-4">
					<p class="h5 mb-1 font-family--jetbrains-mono">Eventos</p>
					<!-- Item -->
					<div class="d-flex gap-2">
						<!-- Cuadrado -->
						<div class="event bg-danger">
							<p class="h5">MAR</p>
							<p class="h4">31</p>
						</div>
						<div class="doble-texto">
							<strong>Entregable 02</strong>
							<p>Sprint 01</p>
						</div>
					</div>
					<!-- Item -->
					<div class="d-flex gap-2">
						<!-- Cuadrado -->
						<div class="event bg-success">
							<p class="h5">ABR</p>
							<p class="h4">21</p>
						</div>
						<div class="doble-texto">
							<strong>Entregable final</strong>
							<p>Sprint 01</p>
						</div>
					</div>
					<!-- Item -->
					<div class="d-flex gap-2">
						<!-- Cuadrado -->
						<div class="event bg-success">
							<p class="h5">MAY</p>
							<p class="h4">12</p>
						</div>
						<div class="doble-texto">
							<strong>Entregable 01</strong>
							<p>Sprint 02</p>
						</div>
					</div>
					<!-- Item -->
					<div class="d-flex gap-2">
						<!-- Cuadrado -->
						<div class="event bg-success">
							<p class="h5">MAY</p>
							<p class="h4">19</p>
						</div>
						<div class="doble-texto">
							<strong>Entregable final</strong>
							<p>Sprint 02</p>
						</div>
					</div>
				</div>
			</aside>
		</div>

		<div id="spinner-wrapper" class="p-4 visually-hidden">
			<div class="spinner-border d-block m-auto" role="status"></div>
		</div>

		<p id="no-more-posts" class="text-center visually-hidden h3 p-4">No hay mas posts</p>

		<footer class="d-flex p-4 bg-black text-white">
			<p class="h4 font-family--jetbrains-mono"><strong>//TECLA</strong>_SOCIAL</p>
		</footer>

		<!-- Bottom Nav bar 📱 -->
		<div class="position-sticky fixed-bottom d-flex justify-content-around bg-tecla-blue d-lg-none px-4 py-2">
			<a href="/pages/feed.html"><i class="icon icon--white bi bi-house-fill"></i></a>
			<a href="/pages/lista-de-amigos.html"><i class="icon icon--white bi bi-people-fill"></i></a>
			<a href="/pages/perfil-de-usuario.html"><img class="icon rounded-circle" src="/public/images/profile-icon.jpg" alt="Usuario" /></a>
		</div>

		<script type="module">
			import { addPost, addPosts } from "../public/js/model/post.js";
			import { getRandomUsers } from "../public/js/api/random-user.js";
			import { getUnsplashImage } from "../public/js/api/unsplash.js";
			import { getPosts } from "../public/js/api/mocki.js";
			import handleScroll from "../public/js/common/handleScroll.js";

			// Renderizar creador de post
			import { renderElement } from "../public/js/view/feed/createPost.js";
			renderElement();

			const SPINNER_WRAPPER = document.getElementById("spinner-wrapper");
			const toggleSpinner = () => SPINNER_WRAPPER.classList.toggle("visually-hidden");

			/*
				Esta página usa 2 APIs:
				- API de randomuser.me para generar usuarios aleatorios
				- API personalizada creada en mocki.io para obtener títulos y tags de posts scrapeados de dev.to
				Ya que la API de mocki te devuelve siempre un array con los mismos 50 posts, obtenemos esos posts y de paso generamos 50 usuarios aleatorios.
			*/
			const posts = await getPosts();
			posts.sort(() => Math.random() - 0.5); // shuffle posts
			const users = await getRandomUsers(posts.length);

			const getPostData = async () => {
				if (users.length === 0 || posts.length === 0) {
					document.removeEventListener("scroll", scrollCallback);
					document.getElementById("no-more-posts").classList.toggle("visually-hidden");
					throw Error("No hay mas posts");
				}

				const user = users.pop();
				const post = posts.pop();

				const newPost = {
					user: user,
					content: {
						title: post.title,
						tags: post.tags,
						imageUrl: post.imageUrl,
					},
				};

				return newPost;
			};

			const createPosts = async (amount) => {
				Promise.all([...Array(amount)].map(() => getPostData()))
					.then((posts) => addPosts(posts))
					.catch((err) => {});
			};

			// Iniciamos la página creando n posts manualmente
			createPosts(5);

			const scrollCallback = () => {
				handleScroll(async () => {
					if (isLoadingNewPost) return;
					isLoadingNewPost = true;
					toggleSpinner();

					// Simular delay en la carga de nuevos posts
					setTimeout(async () => {
						await createPosts(5);
						toggleSpinner();
						isLoadingNewPost = false;
					}, 1000);
				});
			};

			let isLoadingNewPost = false;
			document.addEventListener("scroll", scrollCallback);
		</script>
	</body>
</html>
